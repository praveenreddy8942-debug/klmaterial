<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Connection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a2e;
      color: white;
    }
    .test-result {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid;
    }
    .success {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00ff00;
    }
    .error {
      background: rgba(255, 0, 0, 0.1);
      border-color: #ff0000;
    }
    .info {
      background: rgba(0, 212, 255, 0.1);
      border-color: #00d4ff;
    }
    pre {
      background: #000;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    button {
      background: #00d4ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #0099ff;
    }
  </style>
</head>
<body>
  <h1>üîç Firebase Connection Diagnostics</h1>
  <p>This page will test your Firebase Storage connection and identify the exact issue.</p>
  
  <button onclick="runTests()">üöÄ Run Diagnostics</button>
  <button onclick="location.reload()">üîÑ Refresh</button>
  
  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getStorage, ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const resultsDiv = document.getElementById('results');

    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = message;
      resultsDiv.appendChild(div);
    }

    window.runTests = async function() {
      resultsDiv.innerHTML = '';
      
      addResult('üîÑ Starting diagnostics...', 'info');
      
      // Test 1: Firebase Configuration
      addResult('<strong>Test 1:</strong> Checking Firebase Configuration...', 'info');
      
      const firebaseConfig = {
        apiKey: "AIzaSyDUcVpkiBMd_53FHD4j77pN-MuNuPAv6aU",
        authDomain: "klmaterials.firebaseapp.com",
        projectId: "klmaterials",
        storageBucket: "klmaterials.firebasestorage.app",
        messagingSenderId: "772530551582",
        appId: "1:772530551582:web:ba87999d6602b49787a70f",
        measurementId: "G-JFPKCY2715"
      };

      addResult(`‚úÖ Firebase Config Found:<pre>${JSON.stringify(firebaseConfig, null, 2)}</pre>`, 'success');

      // Test 2: Initialize Firebase
      addResult('<strong>Test 2:</strong> Initializing Firebase...', 'info');
      
      try {
        const app = initializeApp(firebaseConfig);
        addResult('‚úÖ Firebase initialized successfully', 'success');
        
        // Test 3: Get Storage Reference
        addResult('<strong>Test 3:</strong> Connecting to Firebase Storage...', 'info');
        
        const storage = getStorage(app);
        const storageRef = ref(storage);
        addResult(`‚úÖ Storage reference created for bucket: <strong>${firebaseConfig.storageBucket}</strong>`, 'success');
        
        // Test 4: List Files
        addResult('<strong>Test 4:</strong> Attempting to list files in storage...', 'info');
        
        try {
          const result = await listAll(storageRef);
          
          addResult(`‚úÖ Successfully connected to storage!`, 'success');
          addResult(`üìä Found <strong>${result.items.length}</strong> files in storage`, 'success');
          
          if (result.items.length === 0) {
            addResult(`‚ö†Ô∏è <strong>No files found in storage!</strong><br>
              Please upload your materials to Firebase Storage:<br>
              <a href="https://console.firebase.google.com/project/klmaterials/storage/klmaterials.firebasestorage.app/files" 
                 target="_blank" style="color: #00d4ff;">
                üì§ Upload Files Here
              </a>`, 'error');
          } else {
            addResult('<strong>Files Found:</strong>', 'success');
            const fileList = document.createElement('div');
            fileList.innerHTML = '<pre>' + result.items.map((item, i) => 
              `${i + 1}. ${item.name}`
            ).join('\n') + '</pre>';
            resultsDiv.appendChild(fileList);
            
            // Test 5: Try to get download URL for first file
            addResult('<strong>Test 5:</strong> Testing file download access...', 'info');
            
            try {
              const url = await getDownloadURL(result.items[0]);
              addResult(`‚úÖ Successfully got download URL for: <strong>${result.items[0].name}</strong>`, 'success');
              addResult(`üéâ <strong>ALL TESTS PASSED!</strong> Your Firebase is working correctly.<br>
                If materials still don't show on your website, try clearing browser cache (Ctrl+Shift+R or Cmd+Shift+R)`, 'success');
            } catch (urlError) {
              addResult(`‚ùå <strong>Cannot get download URL!</strong><br>
                Error: ${urlError.message}<br>
                Code: ${urlError.code}<br><br>
                This usually means CORS is not configured. Check Firebase Storage CORS settings.`, 'error');
            }
          }
          
        } catch (listError) {
          addResult(`‚ùå <strong>STORAGE ACCESS DENIED!</strong><br><br>
            Error Code: <strong>${listError.code}</strong><br>
            Error Message: ${listError.message}<br><br>
            
            <strong>üîß FIX:</strong> Your Firebase Storage Rules have expired or are blocking access.<br><br>
            
            <strong>Follow these steps:</strong><br>
            1. <a href="https://console.firebase.google.com/project/klmaterials/storage/klmaterials.firebasestorage.app/rules" 
               target="_blank" style="color: #00d4ff;">
               üëâ Click here to open Firebase Storage Rules
            </a><br>
            2. Replace ALL the text with this:<br>
            <pre style="background: #1a1a2e; color: #00ff88; padding: 15px; margin: 10px 0;">
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}</pre>
            3. Click the <strong>"Publish"</strong> button<br>
            4. Come back here and click "Run Diagnostics" again
            `, 'error');
        }
        
      } catch (initError) {
        addResult(`‚ùå <strong>Firebase Initialization Failed!</strong><br>
          Error: ${initError.message}<br><br>
          Check your Firebase configuration settings.`, 'error');
      }
    };
  </script>
</body>
</html>
